<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TekeTeke — Matatu Owner Dashboard</title>
  <style>
    :root{
      --brand:#0ea5e9; --brand-700:#0284c7;
      --bg:#f8fafc; --panel:#ffffff; --border:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
      --bad:#b91c1c; --ok:#065f46; --warn:#b45309;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;margin:0;padding:24px;background:var(--bg);color:var(--ink)}
    a{color:#1976d2;text-decoration:none}
    h2{margin:0 0 10px;color:var(--brand)}
    h3{margin:0 0 10px}
    .wrap{max-width:1100px;margin:0 auto}
    .top{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap}
    .badge{background:#e6fbff;color:#0b3c74;border:1px solid #b6eaff;padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
    .token{display:flex;align-items:center;gap:8px;background:#eef6ff;border:1px solid #cfe3ff;border-radius:8px;padding:8px}
    .token input{min-width:280px;padding:8px;border:1px solid #cfe3ff;border-radius:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field select{padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:9px 12px;cursor:pointer}
    .btn:hover{background:var(--brand-700)}
    .btn.ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .btn.bad{background:var(--bad)}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--warn)}
    .tabs{display:flex;gap:8px;margin:10px 0 14px;flex-wrap:wrap}
    .tab{background:var(--brand);color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .tab.active{background:var(--brand-700)}
    .panel{display:none}
    .panel.active{display:block}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .kv{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
    .kv .k{font-size:12px;color:var(--muted)}
    .kv .v{font-weight:600;margin-top:4px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
    th{background:#eff6ff}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .note{margin-top:8px;background:#fef3c7;color:#92400e;border:1px solid #fde68a;border-radius:8px;padding:8px 10px}
    .table-wrap{max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:#fff}
    #log{background:#0b1020;color:#cfe3ff;border-radius:8px;padding:10px;max-height:200px;overflow:auto}
  </style>
  <script>
    // Safe shims so preview won't break if your global guards exist
    window.ensureAuthOrRoot = window.ensureAuthOrRoot || function(){};
    window.protect = window.protect || function(){};
  </script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h2 style="margin:0">Matatu Owner Dashboard</h2>
      <span class="badge">Owner</span>
      <span class="muted" style="margin-left:auto">
        <a href="/auth/role-select.html">Role Select</a> ·
        <a href="#" id="logoutLink">Logout</a>
      </span>
    </div>

    <!-- Token + API base -->
    <div class="row" style="margin-bottom:12px">
      <div class="token">
        <strong>User token</strong>
        <input id="auth_token" placeholder="Bearer token (supabase user)" />
        <button class="btn" id="save_token">Save</button>
        <span id="tok_state" class="muted"></span>
      </div>
      <div class="row">
        <span class="muted">API Base</span>
        <select id="api_base">
          <option value="">Same origin</option>
        </select>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-for="overview">Overview</div>
      <div class="tab" data-for="vehicle">My Matatu</div>
      <div class="tab" data-for="staff">Staff</div>
      <div class="tab" data-for="tx">Transactions</div>
      <div class="tab" data-for="tools">Tools</div>
    </div>

    <!-- Overview -->
    <section id="panel-overview" class="panel active">
      <div class="card">
        <h3 style="margin-top:0">Quick Snapshot</h3>
        <div class="row" style="margin:10px 0">
          <div class="field" style="flex:1;min-width:240px">
            <label>Find Matatu by Plate
              <input id="ov_plate" placeholder="e.g. KDA123A"/>
            </label>
          </div>
          <button class="btn" id="ov_find">Find</button>
          <span id="ov_found" class="muted"></span>
          <button class="btn ghost" id="ov_refresh" style="margin-left:auto">Refresh</button>
        </div>
        <div class="grid">
          <div class="kv"><div class="k">Plate</div><div class="v" id="ov_plate_v">—</div></div>
          <div class="kv"><div class="k">SACCO</div><div class="v" id="ov_sacco_v">—</div></div>
          <div class="kv"><div class="k">Matatu ID</div><div class="v mono" id="ov_id_v">—</div></div>
        </div>
        <div class="note">Use the <strong>Staff</strong> tab to add/remove staff once your vehicle is selected.</div>
      </div>
    </section>

    <!-- Vehicle -->
    <section id="panel-vehicle" class="panel">
      <div class="card">
        <h3 style="margin-top:0">My Matatu</h3>
        <div class="row">
          <div class="field" style="flex:1;min-width:260px">
            <label>Find by Plate
              <input id="mt_plate" placeholder="e.g. KDA123A"/>
            </label>
          </div>
          <button class="btn" id="mt_find">Find</button>
          <span id="mt_found" class="muted"></span>
        </div>

        <div class="grid" style="margin-top:10px">
          <div class="kv"><div class="k">Plate</div><div class="v" id="mt_plate_v">—</div></div>
          <div class="kv"><div class="k">Owner</div><div class="v" id="mt_owner_v">—</div></div>
          <div class="kv"><div class="k">SACCO</div><div class="v" id="mt_sacco_v">—</div></div>
          <div class="kv"><div class="k">Type</div><div class="v" id="mt_type_v">—</div></div>
          <div class="kv"><div class="k">TLB</div><div class="v" id="mt_tlb_v">—</div></div>
          <div class="kv"><div class="k">Till</div><div class="v" id="mt_till_v">—</div></div>
          <div class="kv"><div class="k">Matatu ID</div><div class="v mono" id="mt_id_v">—</div></div>
        </div>

        <div class="note">Details are read-only here. For staff actions, go to the <strong>Staff</strong> tab.</div>
      </div>
    </section>

    <!-- Staff -->
    <section id="panel-staff" class="panel">
      <div class="card">
        <h3 style="margin-top:0">Manage Staff</h3>

        <!-- Find matatu -->
        <div class="row">
          <div class="field" style="flex:1;min-width:260px">
            <label>Find Matatu by Plate
              <input id="st_plate" placeholder="e.g. KDA123A"/>
            </label>
          </div>
          <button class="btn" id="st_find">Find</button>
          <span id="st_found" class="muted"></span>
          <button class="btn ghost" id="st_reload" title="Reload staff list" style="margin-left:auto">Reload</button>
        </div>

        <!-- Add by email -->
        <div class="row" style="margin-top:10px">
          <div class="field" style="flex:1;min-width:260px">
            <label>Email
              <input id="st_email" placeholder="user@example.com"/>
            </label>
          </div>
          <div class="field">
            <label>Role
              <select id="st_role">
                <option>DRIVER</option>
                <option>MATATU_STAFF</option>
              </select>
            </label>
          </div>
          <button class="btn ok" id="st_add">Add Staff</button>
          <button class="btn" id="st_export">Export CSV</button>
        </div>

        <!-- Staff table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>User</th><th>Role</th><th>Joined</th><th class="mono">User ID</th><th width="120"></th></tr>
            </thead>
            <tbody id="st_tbody"></tbody>
          </table>
        </div>

        <div class="note">
          Uses RPCs: <span class="mono">owner_add_staff_by_email</span>, <span class="mono">owner_remove_staff</span>.
          Listing tries <span class="mono">owner_list_matatu_staff</span>, then falls back to <span class="mono">/api/owner/members?matatu_id=…</span>.
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section id="panel-tx" class="panel">
      <div class="card">
        <h3 style="margin-top:0">Transactions (Today)</h3>
        <div class="row">
          <div class="field" style="flex:1;min-width:260px">
            <label>For Matatu (plate)
              <input id="tx_plate" placeholder="e.g. KDA123A"/>
            </label>
          </div>
          <button class="btn" id="tx_find">Find</button>
          <span id="tx_found" class="muted"></span>
          <button class="btn ghost" id="tx_reload" style="margin-left:auto">Reload</button>
          <button class="btn" id="tx_export">Export CSV</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Time</th></tr></thead>
            <tbody id="tx_tbody"></tbody>
          </table>
        </div>

        <div class="note">
          This tries your RPC <span class="mono">owner_transactions_today</span> (if you created it).  
          If missing, it falls back to <span class="mono">/api/owner/transactions?matatu_id=…</span>.
        </div>
      </div>
    </section>

    <!-- Tools / Logs -->
    <section id="panel-tools" class="panel">
      <div class="card">
        <h3 style="margin-top:0">Logs</h3>
        <div id="log"></div>
      </div>
    </section>
  </div>

  <script>
    try{ ensureAuthOrRoot(); protect('MATATU_OWNER'); }catch(_){}

    // ---------- helpers ----------
    const $ = (id)=>document.getElementById(id);
    const BASE = ()=> $('api_base').value || '';
    const token = ()=> localStorage.getItem('auth_token') || '';
    const H = ()=> ({ 'Content-Type':'application/json', 'Authorization':'Bearer '+token() });

    function log(msg, obj){
      const el = $('log');
      const time = new Date().toLocaleTimeString();
      el.textContent = `[${time}] ${msg}` + (obj ? `\n${JSON.stringify(obj,null,2)}` : "") + "\n\n" + (el.textContent||'');
    }
    function exportTableToCSV(filename, tbodyId){
      const table = document.getElementById(tbodyId).closest('table');
      const rows = [...table.querySelectorAll('tr')];
      const csv = rows.map(row=>{
        const cols = [...row.querySelectorAll('th,td')].map(c => `"${(c.innerText||'').replace(/"/g,'""')}"`);
        return cols.join(',');
      }).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    }

    async function handle(r){
      const text = await r.text();
      let data = {};
      try{ data = text ? JSON.parse(text) : {}; }catch{ data = { error: text || r.statusText }; }
      if (!r.ok) throw new Error((data && (data.error || data.message)) || r.statusText || 'Request failed');
      return data;
    }
    async function jget(p){ const r=await fetch(BASE()+p,{headers:H()}); return handle(r); }
    async function jpost(p,b){ const r=await fetch(BASE()+p,{method:'POST',headers:H(),body:JSON.stringify(b||{})}); return handle(r); }
    async function jrpc(fn,args){ return jpost('/rpc/'+fn, args||{}); }

    // tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const key = t.getAttribute('data-for');
        const panel = document.getElementById('panel-'+key);
        if (panel) panel.classList.add('active');
      };
    });

    // token save
    $('auth_token').value = token();
    $('save_token').onclick = ()=>{
      localStorage.setItem('auth_token', $('auth_token').value.trim());
      $('tok_state').textContent = 'saved ✓';
      setTimeout(()=> $('tok_state').textContent='', 1200);
    };

    // logout
    $('logoutLink')?.addEventListener('click',(e)=>{
      e.preventDefault();
      ['tt_root_token','tt_admin_token','auth_token'].forEach(k=>localStorage.removeItem(k));
      location.replace('/auth/login.html');
    });

    // shared state
    let MATATU_ID = '';
    let MATATU_CTX = null;

    // lookup
    async function lookupMatatuByPlate(plate){
      return jget('/api/lookup/matatu?plate='+encodeURIComponent(plate));
    }

    // populate overview/vehicle cards
    function fillOverview(m){
      $('ov_plate_v').textContent = m.number_plate || '—';
      $('ov_sacco_v').textContent = m.sacco_id || '—';
      $('ov_id_v').textContent = m.id || '—';
    }
    function fillVehicle(m){
      $('mt_plate_v').textContent = m.number_plate || '—';
      $('mt_owner_v').textContent = m.owner_name || '—';
      $('mt_sacco_v').textContent = m.sacco_id || '—';
      $('mt_type_v').textContent  = m.vehicle_type || '—';
      $('mt_tlb_v').textContent   = m.tlb_number || '—';
      $('mt_till_v').textContent  = m.till_number || '—';
      $('mt_id_v').textContent    = m.id || '—';
    }

    // -------- Overview find/refresh ----------
    $('ov_find').onclick = async ()=>{
      try{
        const plate = $('ov_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
        const r = await lookupMatatuByPlate(plate);
        MATATU_ID = r.id || '';
        MATATU_CTX = r || null;
        $('ov_found').textContent = MATATU_ID ? `✅ ${r.number_plate} (${r.id})` : 'Not found';
        if (MATATU_ID){ fillOverview(r); fillVehicle(r); }
      }catch(e){ alert(e.message||e); log('❌ Overview find failed',{error:String(e)}); }
    };
    $('ov_refresh').onclick = ()=>{ if(MATATU_CTX){ fillOverview(MATATU_CTX); fillVehicle(MATATU_CTX); }};

    // -------- Vehicle tab find ----------
    $('mt_find').onclick = async ()=>{
      try{
        const plate = $('mt_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
        const r = await lookupMatatuByPlate(plate);
        MATATU_ID = r.id || '';
        MATATU_CTX = r || null;
        $('mt_found').textContent = MATATU_ID ? `✅ ${r.number_plate} (${r.id})` : 'Not found';
        if (MATATU_ID){ fillOverview(r); fillVehicle(r); }
      }catch(e){ alert(e.message||e); log('❌ Vehicle find failed',{error:String(e)}); }
    };

    // ================= STAFF =================
    function renderStaff(rows){
      const T = $('st_tbody'); T.innerHTML = '';
      (rows||[]).forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.email || ''}</td>
          <td>${row.role || ''}</td>
          <td>${row.joined_at || ''}</td>
          <td class="mono">${row.user_id || ''}</td>
          <td><button class="btn bad" data-id="${row.user_id}">Remove</button></td>`;
        T.appendChild(tr);
      });
      T.onclick = async (e)=>{
        const b = e.target.closest('button'); if(!b) return;
        const uid = b.dataset.id;
        if (!confirm('Remove staff ('+uid+')?')) return;
        try{
          await jrpc('owner_remove_staff', { p_matatu: MATATU_ID, p_user: uid });
          log('🗑️ Removed staff '+uid);
          $('st_reload').click();
        }catch(err){ alert(err.message||err); log('❌ Remove failed', { error: String(err) }); }
      };
    }

    async function loadStaff(){
      if (!MATATU_ID) return alert('Find a Matatu first');
      // Prefer owner listing RPC if you have it; else try sacco admin list; else fallback route.
      let rows = [];
      try{
        rows = await jrpc('owner_list_matatu_staff', { p_matatu: MATATU_ID });
      }catch(_try2){
        try{
          rows = await jrpc('sacco_admin_list_matatu_staff', { p_matatu: MATATU_ID });
        }catch(_try3){
          const d = await jget('/api/owner/members?matatu_id='+encodeURIComponent(MATATU_ID));
          rows = d.items || d || [];
        }
      }
      renderStaff(rows);
      log('📋 Staff listed', rows);
    }

    $('st_find').onclick = async ()=>{
      try{
        const plate = $('st_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
        const r = await lookupMatatuByPlate(plate);
        MATATU_ID = r.id || '';
        MATATU_CTX = r || null;
        $('st_found').textContent = MATATU_ID ? `✅ ${r.number_plate} (${r.id})` : 'Not found';
        if (MATATU_ID){ fillOverview(r); fillVehicle(r); $('st_reload').click(); }
      }catch(e){ alert(e.message||e); log('❌ Staff find failed',{error:String(e)}); }
    };
    $('st_reload').onclick = loadStaff;

    $('st_add').onclick = async ()=>{
      try{
        if (!MATATU_ID) return alert('Find a Matatu first');
        const email = $('st_email').value.trim();
        const role  = $('st_role').value;
        if (!email) return alert('Enter email');
        await jrpc('owner_add_staff_by_email', { p_matatu: MATATU_ID, p_email: email, p_role: role });
        $('st_email').value='';
        log('✅ Added staff by email', { email, role });
        await loadStaff();
      }catch(e){ alert(e.message||e); log('❌ Add staff failed', { error: String(e) }); }
    };

    $('st_export').onclick = ()=> exportTableToCSV('matatu-staff.csv', 'st_tbody');

    // ================= TRANSACTIONS =================
    function renderTx(rows){
      const T = $('tx_tbody'); T.innerHTML='';
      (rows||[]).forEach(x=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.date||''}</td><td>${x.type||x.kind||''}</td><td>${x.amount||''}</td><td>${x.time||''}</td>`;
        T.appendChild(tr);
      });
    }

    async function loadTx(){
      if (!MATATU_ID) return alert('Find a Matatu first for transactions');
      let rows = [];
      // Try RPC first (if you created it)
      try{
        const d = await jrpc('owner_transactions_today', { p_matatu: MATATU_ID });
        rows = Array.isArray(d)? d : (d?.data || []);
      }catch(_){
        // Fallback to your REST route (implement it to return [{date,type,amount,time}, ...])
        try{
          const d2 = await jget('/api/owner/transactions?matatu_id='+encodeURIComponent(MATATU_ID));
          rows = d2.items || d2 || [];
        }catch(__){
          log('ℹ️ No transactions endpoint available; showing empty list.');
        }
      }
      renderTx(rows);
      log('💸 Tx listed', rows);
    }

    $('tx_find').onclick = async ()=>{
      try{
        const plate = $('tx_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
        const r = await lookupMatatuByPlate(plate);
        MATATU_ID = r.id || '';
        MATATU_CTX = r || null;
        $('tx_found').textContent = MATATU_ID ? `✅ ${r.number_plate} (${r.id})` : 'Not found';
        if (MATATU_ID){ fillOverview(r); fillVehicle(r); $('tx_reload').click(); }
      }catch(e){ alert(e.message||e); log('❌ Tx find failed',{error:String(e)}); }
    };
    $('tx_reload').onclick = loadTx;
    $('tx_export').onclick = ()=> exportTableToCSV('matatu-transactions.csv', 'tx_tbody');

    // init: keep things idle until user selects a plate
    log('Ready. Tip: set your Bearer token, then use the Overview or Staff tab to select your matatu by plate.');
  </script>
</body>
</html>
