<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TekeTeke – SACCO Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/nav.js"></script>
  <style>
    :root{
      --brand:#1976d2; --brand-700:#135ba1; --bg:#f5f7fb; --panel:#fff;
      --text:#0b0f19; --muted:#6b7280; --border:#e5e7eb; --ok:#065f46; --bad:#b91c1c;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0;padding:20px}
    h2{color:var(--brand);margin:0 0 12px}
    select,input,button{padding:10px;border:1px solid var(--border);border-radius:8px}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    button.ghost{background:#fff;color:var(--brand)}
    button.bad{background:var(--bad)}
    button.ok{background:var(--ok)}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .tabs{display:flex;gap:8px;margin:8px 0 16px;flex-wrap:wrap}
    .tab{padding:10px 14px;background:var(--brand);color:#fff;border-radius:8px;cursor:pointer}
    .tab.active{background:var(--brand-700)}
    .panel{display:none;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .panel.active{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .k{color:var(--muted);font-size:12px}
    .v{font-weight:700;font-size:20px}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
    th,td{padding:10px;border:1px solid var(--border);text-align:left;vertical-align:top}
    th{background:var(--brand);color:#fff}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .table-wrap{max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:#fff}
    .note{margin-top:8px;background:#fef3c7;border:1px solid #fde68a;color:#92400e;border-radius:8px;padding:8px 10px}
    #log{background:#0b1020;color:#cfe3ff;border-radius:8px;padding:10px;max-height:200px;overflow:auto}
  </style>
</head>
<body>

  <h2>SACCO Dashboard</h2>

  <div class="bar">
    <label>SACCO
      <select id="saccoSelect"></select>
    </label>
    <label>From <input id="fromDate" type="date"></label>
    <label>To <input id="toDate" type="date"></label>
    <button id="applyRange">Apply</button>
    <span class="right k" id="statusMsg"></span>
  </div>

  <div class="tabs">
    <div class="tab active" data-panel="p_matatus">Matatus</div>
    <div class="tab" data-panel="p_summary">Collections</div>
    <div class="tab" data-panel="p_tx">Transactions</div>
    <div class="tab" data-panel="p_savings">Savings</div>
    <div class="tab" data-panel="p_loans">Loans</div>
    <!-- NEW STAFF TABS -->
    <div class="tab" data-panel="p_sacco_staff">SACCO Staff</div>
    <div class="tab" data-panel="p_matatu_staff">Matatu Staff</div>
  </div>

  <!-- Matatus -->
  <section id="p_matatus" class="panel active">
    <div class="row">
      <input id="matatuSearch" placeholder="Search plate…" />
      <button class="ghost" id="reloadMatatus">Reload</button>
      <span class="right k" id="matatuCount"></span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Plate</th><th>Owner</th><th>Phone</th><th>Type</th><th>TLB</th><th>Till</th><th>ID</th>
          </tr>
        </thead>
        <tbody id="matatuTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Collections (totals + chart) -->
  <section id="p_summary" class="panel">
    <div class="grid">
      <div class="card"><div class="k">FARE (gross)</div><div class="v" id="sum_fare">0</div></div>
      <div class="card"><div class="k">SAVINGS</div><div class="v" id="sum_savings">0</div></div>
      <div class="card"><div class="k">LOAN REPAY</div><div class="v" id="sum_loan">0</div></div>
      <div class="card"><div class="k">SACCO FEE</div><div class="v" id="sum_sacco">0</div></div>
    </div>
    <div class="card" style="margin-top:16px">
      <canvas id="summaryChart" height="120"></canvas>
    </div>
  </section>

  <!-- Transactions -->
  <section id="p_tx" class="panel">
    <div class="row">
      <label>Status
        <select id="txStatus">
          <option value="">All</option>
          <option value="SUCCESS">SUCCESS</option>
          <option value="PENDING">PENDING</option>
          <option value="FAILED">FAILED</option>
          <option value="TIMEOUT">TIMEOUT</option>
        </select>
      </label>
      <button class="ghost" id="reloadTx">Reload</button>
      <button id="exportTx">Export CSV</button>
      <span class="right k" id="txCount"></span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th><th>Matatu</th><th>MSISDN</th><th>Fare</th><th>Service Fee</th><th>Status</th><th>ID</th>
          </tr>
        </thead>
        <tbody id="txTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Savings -->
  <section id="p_savings" class="panel">
    <div class="grid">
      <div class="card"><div class="k">Total Savings (range)</div><div class="v" id="sav_total">0</div></div>
      <div class="card"><div class="k">Days</div><div class="v" id="sav_days">0</div></div>
      <div class="card"><div class="k">Avg / day</div><div class="v" id="sav_avg">0</div></div>
    </div>
    <div class="card" style="margin-top:16px">
      <canvas id="savingsChart" height="120"></canvas>
    </div>
    <p class="k" style="margin-top:8px">Note: this uses the same totals as Collections. For a per-day breakdown from the server, we can add <span class="mono">/api/sacco/:id/summary/daily</span>.</p>
  </section>

  <!-- Loans -->
  <section id="p_loans" class="panel">
    <div class="grid">
      <div class="card"><div class="k">Total Loan Repay (range)</div><div class="v" id="loan_total">0</div></div>
      <div class="card"><div class="k">Days</div><div class="v" id="loan_days">0</div></div>
      <div class="card"><div class="k">Avg / day</div><div class="v" id="loan_avg">0</div></div>
    </div>
    <div class="card" style="margin-top:16px">
      <canvas id="loansChart" height="120"></canvas>
    </div>
  </section>

  <!-- NEW: SACCO STAFF -->
  <section id="p_sacco_staff" class="panel">
    <h3 style="margin:0 0 8px">SACCO Staff Management</h3>
    <div class="note">Selected SACCO: <span class="mono" id="ss_sacco_lbl">—</span></div>

    <div class="row" style="margin-top:10px">
      <input id="ss_email" placeholder="user@example.com" style="min-width:260px" />
      <select id="ss_role">
        <option value="SACCO_STAFF">SACCO_STAFF</option>
        <option value="SACCO_ADMIN">SACCO_ADMIN</option>
      </select>
      <button class="ok" id="ss_add">Add Staff</button>
      <button class="ghost" id="ss_reload">Reload</button>
      <button id="ss_export">Export CSV</button>
      <span class="right k" id="ss_count"></span>
    </div>

    <div class="table-wrap">
      <table>
        <thead><tr><th>User</th><th>Role</th><th>Joined</th><th class="mono">User ID</th><th width="120"></th></tr></thead>
        <tbody id="ss_tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- NEW: MATATU STAFF (from SACCO perspective) -->
  <section id="p_matatu_staff" class="panel">
    <h3 style="margin:0 0 8px">Matatu Staff Management</h3>
    <div class="row">
      <input id="ms_plate" placeholder="Find Matatu by Plate e.g. KDA123A" style="min-width:260px" />
      <button id="ms_find">Find</button>
      <span class="k" id="ms_found">—</span>
      <button class="ghost" id="ms_reload" style="margin-left:auto">Reload Staff</button>
      <button id="ms_export">Export CSV</button>
    </div>

    <div class="row" style="margin-top:10px">
      <input id="ms_email" placeholder="user@example.com" style="min-width:260px" />
      <select id="ms_role">
        <option value="DRIVER">DRIVER</option>
        <option value="MATATU_STAFF">MATATU_STAFF</option>
      </select>
      <button class="ok" id="ms_add">Add Staff</button>
    </div>

    <div class="table-wrap" style="margin-top:10px">
      <table>
        <thead><tr><th>User</th><th>Role</th><th>Joined</th><th class="mono">User ID</th><th width="120"></th></tr></thead>
        <tbody id="ms_tbody"></tbody>
      </table>
    </div>
    <div class="note">If RPCs aren’t available, this falls back to <span class="mono">/u/matatu/{id}/staff</span> add/list/remove routes.</div>
  </section>

<script>
(function(){
  // Auth guards
  if (typeof ensureAuthOrRoot === 'function') ensureAuthOrRoot();
  if (typeof protectAny === 'function') {
    protectAny(['SACCO_ADMIN','SACCO_STAFF']);
  } else if (typeof protect === 'function') {
    protect('SACCO_STAFF');
  }

  // ---------- utils ----------
  const $ = id => document.getElementById(id);
  const fmt = n => Number(n||0).toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const todayISO = () => new Date().toISOString().slice(0,10);
  const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };
  const auth = ()=> (window.TT && TT.getAuth && TT.getAuth()) || '';

  // tiny fetch helpers (bearer-aware)
  async function handle(r){
    const t = await r.text();
    let j = {};
    try{ j = t ? JSON.parse(t) : {}; }catch{ j = { error: t || r.statusText }; }
    if (!r.ok) throw new Error(j.error || j.message || r.statusText || 'Request failed');
    return j;
  }
  async function jget(path){
    // prefer TT.jget when available (handles base, token etc.)
    if (window.TT && typeof TT.jget==='function') return TT.jget(path);
    const r = await fetch(path, { headers: { 'Authorization': 'Bearer '+auth() }});
    return handle(r);
  }
  async function jpost(path, body){
    const r = await fetch(path, {
      method:'POST',
      headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+auth() },
      body: JSON.stringify(body||{})
    });
    return handle(r);
  }
  async function jrpc(fn, args){
    return jpost('/rpc/'+fn, args||{});
  }

  // ---------- tabs ----------
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      $(t.dataset.panel).classList.add('active');
    };
  });

  // ---------- date defaults (last 7 days) ----------
  $('toDate').value = todayISO();
  $('fromDate').value = addDays(todayISO(), -6);

  // ---------- state ----------
  let currentSacco = null;
  let chartSummary, chartSavings, chartLoans;
  let cachedTotals = null;

  // choose base for user routes (auth vs fallback)
  const baseU = '/u'; // this dashboard is for authenticated SACCO roles

  // ---------- load sacco list ----------
  async function loadSaccos(){
    const sel = $('saccoSelect');
    sel.innerHTML = '<option value="">— choose —</option>';
    const res = await jget('/u/my-saccos'); // expects items [{sacco_id, name}]
    const items = (res.items||res.data||[]).map(x=>({ id: x.sacco_id, name: x.name || x.sacco_name || x.sacco_id }));
    items.forEach(s=>{
      const o=document.createElement('option');
      o.value=s.id; o.textContent=s.name || s.id; sel.appendChild(o);
    });
    $('statusMsg').textContent = `${items.length} SACCO(s)`;
  }

  // ---------- matatus ----------
  async function loadMatatus(){
    if(!currentSacco) return;
    const data = await jget(`${baseU}/sacco/${currentSacco}/matatus`);
    const q = $('matatuSearch').value.trim().toUpperCase();
    const rows = (data.items||[]).filter(m => !q || (m.number_plate||'').toUpperCase().includes(q));
    const T = $('matatuTbody'); T.innerHTML='';
    rows.forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m.number_plate||''}</td>
        <td>${m.owner_name||''}</td>
        <td>${m.owner_phone||''}</td>
        <td>${m.vehicle_type||''}</td>
        <td>${m.tlb_number||''}</td>
        <td>${m.till_number||''}</td>
        <td class="mono">${m.id}</td>`;
      T.appendChild(tr);
    });
    $('matatuCount').textContent = `${rows.length} matatu(s)`;
  }

  // ---------- helper: date list + even-split series (until daily endpoint exists) ----------
  function enumerateDays(a,b){
    const out=[]; let d=new Date(a+"T00:00:00"); const end = new Date(b+"T00:00:00");
    while (d <= end){ out.push(d.toISOString().slice(0,10)); d.setDate(d.getDate()+1); }
    return out;
  }
  function evenSeries(total, daysCount){ const v = (Number(total||0)/Math.max(1,daysCount)); return Array.from({length:daysCount},()=>v); }

  // ---------- summary (totals + charts) ----------
  async function loadSummary(){
    if(!currentSacco) return;
    const from = $('fromDate').value, to = $('toDate').value;
    const res = await jget(`${baseU}/sacco/${currentSacco}/summary?from=${from}&to=${to}`);
    cachedTotals = res.totals || {};
    const t = cachedTotals;

    $('sum_fare').textContent = fmt(t.FARE||0);
    $('sum_savings').textContent = fmt(t.SAVINGS||0);
    $('sum_loan').textContent = fmt(t.LOAN_REPAY||0);
    $('sum_sacco').textContent = fmt(t.SACCO_FEE||0);

    const days = enumerateDays(from, to);
    renderChart('summaryChart', 'SACCO Fee (KES)', days, evenSeries(t.SACCO_FEE||0, days.length));
    $('sav_total').textContent = fmt(t.SAVINGS||0);
    $('sav_days').textContent = days.length;
    $('sav_avg').textContent = fmt((t.SAVINGS||0)/Math.max(1,days.length));
    renderChart('savingsChart', 'Savings (KES)', days, evenSeries(t.SAVINGS||0, days.length));
    $('loan_total').textContent = fmt(t.LOAN_REPAY||0);
    $('loan_days').textContent = days.length;
    $('loan_avg').textContent = fmt((t.LOAN_REPAY||0)/Math.max(1,days.length));
    renderChart('loansChart', 'Loan Repay (KES)', days, evenSeries(t.LOAN_REPAY||0, days.length));
  }

  function renderChart(canvasId, label, labels, values){
    const ctx = document.getElementById(canvasId);
    if (ctx._inst) ctx._inst.destroy();
    ctx._inst = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ label, data: values, borderColor:'#1976d2', backgroundColor:'transparent', tension:.25 }]},
      options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // ---------- transactions ----------
  async function loadTx(){
    if(!currentSacco) return;
    const limit = 200;
    const status = $('txStatus').value;
    const res = await jget(`${baseU}/sacco/${currentSacco}/transactions?limit=${limit}${status?`&status=${encodeURIComponent(status)}`:''}`);
    const items = res.items || [];
    const T = $('txTbody'); T.innerHTML='';
    items.forEach(tx=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(tx.created_at).toLocaleString()}</td>
        <td class="mono">${tx.matatu_id||''}</td>
        <td class="mono">${tx.passenger_msisdn||''}</td>
        <td>${fmt(tx.fare_amount_kes||0)}</td>
        <td>${fmt(tx.service_fee_kes||0)}</td>
        <td>${tx.status}</td>
        <td class="mono">${tx.id}</td>`;
      T.appendChild(tr);
    });
    $('txCount').textContent = `${items.length} row(s)`;
  }

  function exportTableToCSV(filename, tableBodyId){
    const tbody = document.getElementById(tableBodyId);
    const table = tbody.closest('table');
    const rows = [...table.querySelectorAll('tr')];
    const csv = rows.map(r => {
      const cols = [...r.querySelectorAll('th,td')].map(c => `"${(c.innerText||'').replace(/"/g,'""')}"`);
      return cols.join(',');
    }).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  }

  // ---------- SACCO STAFF ----------
  async function loadSaccoStaff(){
    if (!currentSacco) return alert('Choose a SACCO first');
    $('ss_sacco_lbl').textContent = currentSacco;
    let rows = [];
    try{
      rows = await jrpc('sacco_admin_list_staff', { p_sacco: currentSacco });
    }catch(_){
      // Fallback REST (adjust to your server paths if different)
      const d = await jget(`${baseU}/sacco/${currentSacco}/staff`);
      rows = d.items || d || [];
    }
    const T = $('ss_tbody'); T.innerHTML='';
    (rows||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.email || r.user_email || ''}</td>
        <td>${r.role || ''}</td>
        <td>${r.joined_at || r.created_at || ''}</td>
        <td class="mono">${r.user_id || r.uid || ''}</td>
        <td><button class="bad" data-uid="${r.user_id || r.uid}">Remove</button></td>`;
      T.appendChild(tr);
    });
    $('ss_count').textContent = `${(rows||[]).length} member(s)`;
    T.onclick = async (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const uid = b.dataset.uid;
      if (!confirm('Remove staff '+uid+' from SACCO?')) return;
      try{
        try{
          await jrpc('sacco_admin_remove_staff', { p_sacco: currentSacco, p_user: uid });
        }catch(_){
          await jpost(`${baseU}/sacco/${currentSacco}/staff/remove`, { user_id: uid });
        }
        await loadSaccoStaff();
        alert('🗑️ Removed');
      }catch(err){ alert(err.message||err); }
    };
  }
  $('ss_add').onclick = async ()=>{
    try{
      if (!currentSacco) return alert('Choose a SACCO first');
      const email = $('ss_email').value.trim();
      const role  = $('ss_role').value;
      if (!email) return alert('Enter email');
      try{
        await jrpc('sacco_admin_add_staff_by_email', { p_sacco: currentSacco, p_email: email, p_role: role });
      }catch(_){
        await jpost(`${baseU}/sacco/${currentSacco}/staff/add`, { email, role });
      }
      $('ss_email').value='';
      await loadSaccoStaff();
      alert('✅ Added');
    }catch(e){ alert(e.message||e); }
  };
  $('ss_reload').onclick = loadSaccoStaff;
  $('ss_export').onclick = ()=> exportTableToCSV('sacco-staff.csv', 'ss_tbody');

  // ---------- MATATU STAFF (from SACCO) ----------
  let MS_MATATU = '';
  async function lookupMatatuByPlate(plate){
    return jget('/api/lookup/matatu?plate='+encodeURIComponent(plate));
  }
  async function loadMatatuStaff(){
    if (!MS_MATATU) return alert('Find a matatu first');
    let rows = [];
    try{
      rows = await jrpc('sacco_admin_list_matatu_staff', { p_matatu: MS_MATATU });
    }catch(_){
      const d = await jget(`${baseU}/matatu/${MS_MATATU}/staff`);
      rows = d.items || d || [];
    }
    const T = $('ms_tbody'); T.innerHTML='';
    (rows||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.email || r.user_email || ''}</td>
        <td>${r.role || ''}</td>
        <td>${r.joined_at || r.created_at || ''}</td>
        <td class="mono">${r.user_id || r.uid || ''}</td>
        <td><button class="bad" data-uid="${r.user_id || r.uid}">Remove</button></td>`;
      T.appendChild(tr);
    });
    T.onclick = async (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const uid = b.dataset.uid;
      if (!confirm('Remove matatu staff '+uid+'?')) return;
      try{
        try{
          await jrpc('sacco_admin_remove_matatu_staff', { p_matatu: MS_MATATU, p_user: uid });
        }catch(_){
          await jpost(`${baseU}/matatu/${MS_MATATU}/staff/remove`, { user_id: uid });
        }
        await loadMatatuStaff();
        alert('🗑️ Removed');
      }catch(err){ alert(err.message||err); }
    };
  }
  $('ms_find').onclick = async ()=>{
    try{
      const plate = $('ms_plate').value.trim().toUpperCase(); if(!plate) return alert('Enter plate');
      const r = await lookupMatatuByPlate(plate);
      MS_MATATU = r.id || '';
      $('ms_found').textContent = MS_MATATU ? `✅ ${r.number_plate} (${MS_MATATU})` : 'Not found';
      if (MS_MATATU) $('ms_reload').click();
    }catch(e){ alert(e.message||e); }
  };
  $('ms_reload').onclick = loadMatatuStaff;
  $('ms_add').onclick = async ()=>{
    try{
      if (!MS_MATATU) return alert('Find a matatu first');
      const email = $('ms_email').value.trim();
      const role = $('ms_role').value;
      if (!email) return alert('Enter email');
      try{
        await jrpc('sacco_admin_add_matatu_staff_by_email', { p_matatu: MS_MATATU, p_email: email, p_role: role });
      }catch(_){
        await jpost(`${baseU}/matatu/${MS_MATATU}/staff/add`, { email, role });
      }
      $('ms_email').value='';
      await loadMatatuStaff();
      alert('✅ Added');
    }catch(e){ alert(e.message||e); }
  };
  $('ms_export').onclick = ()=> exportTableToCSV('matatu-staff.csv','ms_tbody');

  // ---------- wiring ----------
  $('saccoSelect').onchange = async ()=>{
    currentSacco = $('saccoSelect').value || null;
    $('ss_sacco_lbl').textContent = currentSacco || '—';
    await Promise.allSettled([loadMatatus(), loadSummary(), loadTx(), loadSaccoStaff()]);
  };
  $('applyRange').onclick = ()=> loadSummary();
  $('matatuSearch').oninput = ()=> { clearTimeout(window._mtT); window._mtT=setTimeout(loadMatatus, 200); };
  $('reloadMatatus').onclick = loadMatatus;
  $('txStatus').onchange = loadTx;
  $('reloadTx').onclick = loadTx;
  $('exportTx').onclick = ()=> exportTableToCSV('transactions.csv','txTbody');

  // ---------- init ----------
  async function init(){
    try{
      await loadSaccos();
      const sel = $('saccoSelect');
      if (sel.options.length > 1){
        sel.selectedIndex = 1;
        currentSacco = sel.value;
        $('ss_sacco_lbl').textContent = currentSacco;
      }
      await Promise.allSettled([loadMatatus(), loadSummary(), loadTx(), loadSaccoStaff()]);
    }catch(e){
      $('statusMsg').textContent = e.message;
      console.error(e);
      alert('Load error: '+e.message);
    }
  }
  init();
})();
</script>
</body>
</html>
